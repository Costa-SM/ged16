---
lang: pt  
title: "GED-16: Análise de Regressão"
subtitle: "AULA07: Prática (1o. semestre/2023)"
author: "Prof. Denise B. Ferrari"
date: "2023-04-19"  
format:
  html:
    theme: cosmo
execute:
  echo: true
  eval: true
  warning: false    
---
```{r include = FALSE}
library(tidyverse)
library(gridExtra)
```

----

Abalone é um tipo de molusco que vive em águas marinhas costeiras em diversas regiões do globo. A concha do abalone apresenta tamanho que varia entre 10 a 25cm e sua coloração interior iridescente nacarada é muito valorizada na confecção de jóias e ornamentos; além disso, a carne do animal é considerada uma iguaria em muitos países. Devido ao seu alto valor comercial e consequente pesca excessiva, além da degradação de seu habitat pela ação humana, diversas espécies de abalone atualmente correm risco de extinção. Existem mais de 100 espécies de abalone ao redor do mundo, das quais cerca de 15 são produzidas por meio de aquicultura. Determinar a idade do abalone de maneira acurada é importante tanto em termos comerciais (o valor comercial do abalone está associado à sua idade) bem como em termos ambientais (condições ambientais podem afetar a saúde do animal). A idade do animal pode ser determinada a partir da contagem do número de anéis na concha, utilizando um microscópio, a partir de um procedimento delicado e trabalhoso.


![Abalone (Image by <a href="https://pixabay.com/users/lisaleo-3220940/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4919586">Lisa Yount</a> from <a href="https://pixabay.com//?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4919586">Pixabay</a>)](img/abalone.jpg){width=80%}

Os dados disponíveis no arquivo `data/abalone/abalone.data` foram
obtidos no [UCI Machine Learning Repository](https://archive.ics.uci.edu/ml/datasets/Abalone) e são bastante utilizados na investigação de métodos de Machine Learning. Tais dados foram coletados a partir do estudo original:

Warwick J Nash, Tracy L Sellers, Simon R Talbot, Andrew J Cawthorn and
	Wes B Ford (1994) "The Population Biology of Abalone (_Haliotis_
	species) in Tasmania. I. Blacklip Abalone (_H. rubra_) from the
	North	Coast and Islands of Bass Strait", Sea Fisheries Division,
	Technical Report No. 48 (ISSN 1034-3288).

O principal objetivo do projeto era determinar a idade do molusco a partir de medidas físicas do animal mais fáceis de serem obtidas. Os dados originais foram pré-processados no sentido de remover observações faltantes e os valores das variáveis contínuas foram dividos por 200. Há um total de 4177 observações coletadas para 9 variáveis:

1. `sex`: sexo do animal (M, F, I)
2. `length`: maior comprimento da concha (mm)
3. `diameter`: comprimento perpendicular à `length` (mm)
4. `height`: comprimento da carne da concha (mm)
5. `whole_w`: peso do animal (g)
6. `shucked_w`: peso da carne (g)
7. `viscera_w`: peso das vísceras (g)
8. `shell_w`: peso da concha (g)
9. `rings`: número de anéis (a idade é obtida somando 1.5)

Mais informações a respeito dos dados podem ser obtidas no arquivo `data/abalone/abalone.names`.



----

# Análise Exploratória de Dados

Conduza a análise exploratória da massa de dados `abalone`, a fim de compreender suas características principais.   
Voltaremos a utilizar essa massa de dados em atividades futuras.

```{r eval=TRUE}
rm(list=ls())
abalone <- read_csv("data/abalone/abalone.data", col_names = FALSE)
names(abalone) <- c("sex", "length", "diameter", "height", "whole_w", "shucked_w", "viscera_w", "shell_w", "rings")
```

Começamos identificando a estrutura dos dados:
```{r eval=TRUE}
str(abalone)
```
Percebemos que as variáveis já possuem nomes explicativos. Porém, percebe-se que `sex` está com tipo `char` quando deveria ser `Factor`. Vamos também obter a idade, a partir do número de anéis do Abalone, e retornar os valores contínuos para suas escalas originais (multiplicar por 200).

```{r eval=TRUE}
abalone <- abalone %>% mutate_at("sex", as.factor)
abalone$age <- abalone$rings + 1.5

abalone$length <- abalone$length * 200
abalone$diameter <- abalone$diameter * 200
abalone$height <- abalone$height * 200
abalone$whole_w <- abalone$whole_w * 200
abalone$shucked_w <- abalone$shucked_w * 200
abalone$viscera_w <- abalone$viscera_w * 200
abalone$shell_w <- abalone$shell_w * 200
```

Dessa forma, temos o sumário do conjunto de dados:


```{r eval=TRUE}
summary(abalone)
```

Percebe-se que algumas observações possuem altura zero. Avaliando essas observações:

```{r eval=TRUE}
abalone[abalone$height==0,]
```
Obtemos duas observações que não fazem sentido (altura zero e pesos diferentes de zero). Podemos retirá-las do conjunto de dados.
```{r eval=TRUE}
abalone <- abalone[abalone$height!=0,]
```

  
# PARTE 3: Construção de Modelos

Continuaremos considerando que a idade do abalone seja dada pela seguinte forma:

$$\textsf{age} = \textsf{rings} + \delta, \quad \delta \sim N(\mu = 1.5, \sigma = 0.5)$$

```{r}
set.seed(16)
abalone <- abalone %>%
  # cria nova variável `age`
  mutate(age = rings + rnorm(n = nrow(abalone), mean = 1.5, sd = 0.5))
```

Utilize o procedimento para construção de modelos para prever a idade de um abalone (`age`):

**Modelo I:** considere como variáveis explicativas `length`, `diameter`, `shell_w` e `sex` (e transformações).

**Modelo II:** considere como variáveis explicativas `height`, `diameter`, `shell_w` e `sex` (e transformações).

Lembre-se que os passos apropriados em análise de regressão consistem em:

**construção do modelo**

1. formulação do modelo   
2. ajuste do modelo  
3. avaliação do modelo

Para a formulação dos modelos, devemos utilizar o seguinte procedimento:  

1. inclusão de variáveis quantitativas (polinomiais, transformações, etc.);  
2. inclusão de variáveis qualitativas;  
3. inclusão de interações entre termos contendo variáveis quantitativas e qualitativas.


**utilização do modelo**

 + para realizar inferências
 + para auxiliar o processo de tomada de decisão
 
Não esqueça de realizar análise de resíduos, inferências e validação do modelo. Forneça interpretações e discussão para os resultados obtidos.

---

### Construção do Modelo 1

#### 1.1) Modelo para a Variável Quantitativa

A princípio, vamos construir o modelo com os termos quadráticos de cada variável explicativa quantitativa:
$$
  E[age] = \beta_0 + \beta_1 length + \beta_{11}length^2  + \beta_2 diameter + \beta_{22} diameter^2 +  \beta_3 shell_w + \beta_{33} shell_w^2 + \beta_{12} length \cdot diameter + \beta_{13} length \cdot shell_w + \beta_{23} diameter \cdot shell_w
$$
Começaremos avaliando a correlação dos termos lineares e quadráticos:
```{r}
cor(abalone$length, abalone$length^2)
cor(abalone$diameter, abalone$diameter^2)
cor(abalone$shell_w, abalone$shell_w^2)

```
Percebe-se que todas as correlações são muito altas. Podemos conferir esse comportamento visualmente:

```{r}
#| layout-ncol: 2

# diagramas de dispersão
ggplot(abalone, aes(x = length, y = length^2)) +
  geom_point() +
  ggtitle("Diagrama de dispersão: `length^2` x `length`")
ggplot(abalone, aes(x = diameter, y = diameter^2)) +
  geom_point() +
  ggtitle("Diagrama de dispersão: `diameter^2` x `diameter`")
ggplot(abalone, aes(x = shell_w, y = shell_w^2)) +
  geom_point() +
  ggtitle("Diagrama de dispersão: `shell_w^2` x `shell_w`")
```
Vamos então centralizar as variáveis explicativas:

```{r}
# centralizando a variável explicativa
abalone <- abalone |>
  mutate(diameter_c = diameter - mean(diameter), 
         shell_w_c = shell_w - mean(shell_w),
         length_c = length - mean(length)) 

# novas correlações
cor(abalone$length_c, abalone$length_c^2)
cor(abalone$diameter_c, abalone$diameter_c^2)
cor(abalone$shell_w_c, abalone$shell_w_c^2)
```
Percebe-se uma redução significativa em todas as correlações. Podemos agora construir um modelo inicial com as variáveis explicativas quantitativas centralizadas:

```{r}
# modelo polinomial de 2a. ordem completo para as variáveis quantitativas
m1_quant <- lm(age ~ I(length_c^2) + I(diameter_c^2) + I(shell_w_c^2) + length_c*shell_w_c+ diameter_c*length_c + diameter_c* shell_w_c  , data = abalone)

# resumo do modelo 
summary(m1_quant)
```

Percebe-se que o modelo é significativo (passa no teste-F global com valor-p da ordem de e-16) e o coeficiente de determinação ajustado indica que aproximadamente 47.2% da variabilidade na resposta é explicada pelo modelo. Com $\alpha = 5%$, percebemos que os coeficientes de `shell_w_c^2`, `diameter_c`, `length_c:shell_w_c` e `shell_w_c:diameter_c` não são significantes. Vamos considerar um modelo reduzido sem essas variáveis, exceto por `diameter_c`, uma vez que o princípio da hierarquia determina que, se `diameter_c` for removido, `diameter_c^2` também deve ser, porém o modelo considera `diameter_c^2` como estatisticamente significante, manteremos o termo linear. 

```{r}
# modelo reduzido
m1_red <- lm(age ~ I(length_c^2) + I(diameter_c^2) + diameter_c*length_c + shell_w_c  , data = abalone)
# resumo do modelo reduzido 
summary(m1_red)
```
Todos os coeficientes são estatisiticamente significantes, o modelo reduzido é significativo pela estatística F e o coeficiente de determinação ajustado indica que aproximadamente 46.3% da variabilidade na resposta é explicada pelo modelo.

Vamos agora realizar o teste de hipótese a seguir:
Ho: $\beta_{33} = \beta_{13} = \beta_{23} = 0$  
Ha: nem todos os coeficientes são nulos

```{r}
# teste-F (comparação de modelos aninhados)
anova(m1_red, m1_quant, test="F")
```
O teste indica que podemos rejeitar a hipótese nula, logo não podemos concluir que os três coeficientes são nulos. Vamos tentar incluir `shell_w_c^2` no modelo reduzido e avaliar novamente:

```{r}
# modelo reduzido
m1_red_2 <- lm(age ~ I(length_c^2) + I(diameter_c^2) + I(shell_w_c^2) +  diameter_c*length_c + shell_w_c , data = abalone)
# resumo do modelo reduzido 
summary(m1_red_2)
```
Incluindo novamente `shell_w_c^2`, percebemos que o termo agora recebe p-valor muito baixo, indicando ser significante. Percebemos nesse ultimo modelo tambem que `diameter_c` voltou a ser considerado não significativo (ainda que esteja no limiar), porém o termo de interação `diameter_c:length_c` e o termo quadrático `diameter_c^2` ainda são significativos. Esse modelo reduzido também é significativo pela estatística F e o coeficiente de determinação ajustado indica que aproximadamente 47.2% da variabilidade na resposta é explicada pelo modelo. Vamos compará-lo ao modelo `m1_quant` agora, com as seguintes hipóteses:

Ho: $\beta_{13} = \beta_{23} = 0$  
Ha: nem todos os coeficientes são nulos
```{r}
# teste-F (comparação de modelos aninhados)
anova(m1_red_2, m1_quant, test="F")
```
Ainda não podemos inferir, com 95% de confiança, que os coeficientes são nulos (rejeita-se a hipótese nula). Vamos adicionar novamente o termo  `length_c:shell_w_c`, pois ele possui menor p-valor em `m1_quant` do que `shell_w_c:diameter_c`:

```{r}
# modelo reduzido
m1_red_3 <- lm(age ~ I(length_c^2) + I(diameter_c^2) + I(shell_w_c^2) +  diameter_c*length_c + shell_w_c*length_c , data = abalone)
# resumo do modelo reduzido 
summary(m1_red_3)
```
O modelo é significante pela estatística F e o coeficiente de determinação ajustado indica que aproximadamente 47.2% da variabilidade na resposta é explicada por ele. Percebe-se que a tabela ANOVA indica que apenas `diameter_c` é não significante agora.

Realizando o teste de hipótese ao comparar com `m1_quant`:
Ho: $\beta_{23} = 0$  
Ha: $\beta_{23} \neq 0$
```{r}
# teste-F (comparação de modelos aninhados)
anova(m1_red_3, m1_quant, test="F")
```
Não podemos rejeitar a hipótese nula. Aceitamos-a, portanto, e temos um modelo reduzido da forma
$$
  E[age] = \beta_0 + \beta_1 length + \beta_{11}length^2  + \beta_2 diameter + \beta_{22} diameter^2 +  \beta_3 shell_w + \beta_{33} shell_w^2 + \beta_{12} length \cdot diameter + \beta_{13} length \cdot shell_w
$$
Podemos prosseguir com a análise de resíduos para avaliar a validade do modelo:

```{r}
#| layout-ncol: 2

# Constrói tabela com dados do modelo `m_red`
abalone_m1_quant_red_3_data <- abalone %>%
  # inclui coluna com valores ajustados
  mutate(fitted = m1_red_3$fit) %>%
  mutate(resid = m1_red_3$res)

# Gera gráficos dos resíduos:
ggplot(abalone_m1_quant_red_3_data, aes(x = fitted, y = resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ggtitle("gráfico de resíduos: modelo m1_red_3") +
  labs(y = "resíduos", x = "resposta ajustada (age)")
# Gráfico de quantis
ggplot(abalone_m1_quant_red_3_data, aes(sample = resid)) +
  stat_qq() + stat_qq_line() +
  ggtitle("gráfico de quantis normais") +
  labs(y = "quantis amostrais", x = "quantis teóricos (dist. normal)") 
```
O gráfico de resíduos indica um efeito cone, com o aumento da variância com o aumento de age. Conferiremos essa hipótese a seguir com o teste de Breusch-Pagan. Porém, não parece existir tendência de variação sistemática nos resíduos. O gráfico de quantis sugere desvio da normalidade, pequeno na cauda esquerda e mais acentuado na cauda direita. Esse desvio provavelmente não causará grandes problemas, mas é possível que transformações de variáveis ajudem a reduzir a fuga de normalidade.

```{r}
# Teste de Homoscedasticidade de Breusch-Pagan
# Ho: sigma^2  = cte
# Ha: sigma^2 != cte

library(lmtest)
bptest(m1_red_3)
# Teste de Homoscedasticidade de Breusch-Pagan
# Ho: sigma^2  = cte
# Ha: sigma^2 != cte

library(lmtest)
bptest(m1_red_3)
```
De fato, os testes rejeitam as hipóteses nulas e confirmam as violações nas hipóteses de homoscedasticidade e de normalidade. 

#### 1.2)Inclusão da Variável Categórica

Prosseguiremos adicionando a variável categórica `sex` ao modelo reduzido `m1_red_3`:¨
```{r}
# modelo que inclui variável explicativa qualitativa `cylinder`
m_quali <- lm(age ~ I(length_c^2) + I(diameter_c^2) + I(shell_w_c^2) +  diameter_c*length_c + shell_w_c*length_c  + sex, data = abalone)

# resumo do modelo
summary(m_quali)
```
Do resumo da regressão, percebemos que o modelo é significativo (baixo valor-p para a estatística-F do teste global para a regressão), e a variável categórica contribui com informação adicional quando avaliamos a diferença entre sexo feminino e não identificado, enquanto o masculino não é tão significativo. Percebe-se que o coeficiente de determinação ajustado é um pouco superior àquele do modelo sem a variável categórica.

<<<<<<< HEAD
Podemos avaliar a significância incremental das variáveis explicativas, utilizando ANOVA:
```{r}
# Tabela ANOVA para o modelo que 
anova(m_quali)
```
Percebe-se que `sex` contribui de forma signicativa para reduzir a variabilidade da resposta. Nessa análise, `diameter_c^2`, `diameter_c:length_c` e `length_c:shell_w_c` contribuem pouco, porém, como visto na seção anterior, são necessárias para a especificação do modelo.

#### 1.3) Inclusão de Termos de Interação entre as Variáveis Quantitativas e a Variável Categórica

Vamos considerar agora a existência de interação entre as variáveis quantitativas e a variável categórica `sex`. Iniciaremos a análise visualizando se há evidências de interação entre tais variáveis:

```{r}
#| layout-ncol: 2

ggplot(abalone, aes(x = length_c, y = age)) +
  # adiciona pontos 
  # (cores e símbolos distintos para diferentes classes da variável `cylinder`)
  geom_point(aes(color = sex, shape = sex)) + 
  # adiciona retas de tendência
  geom_smooth(aes(color = sex), method = "lm", se = FALSE) +
  ggtitle("`age` x `length_c`, para diferentes níveis de `sex`")
ggplot(abalone, aes(x = diameter_c, y = age)) +
  # adiciona pontos 
  # (cores e símbolos distintos para diferentes classes da variável `cylinder`)
  geom_point(aes(color = sex, shape = sex)) + 
  # adiciona retas de tendência
  geom_smooth(aes(color = sex), method = "lm", se = FALSE) +
  ggtitle("`age` x `diameter_c`, para diferentes níveis de `sex`")
ggplot(abalone, aes(x = shell_w_c, y = age)) +
  # adiciona pontos 
  # (cores e símbolos distintos para diferentes classes da variável `cylinder`)
  geom_point(aes(color = sex, shape = sex)) + 
  # adiciona retas de tendência
  geom_smooth(aes(color = sex), method = "lm", se = FALSE) +
  ggtitle("`age` x `shell_w_c`, para diferentes níveis de `sex`")
```

Nos três gráficos, identifica-se que a classe "I" é a que mais se difere das demais, sendo as retas de "F" e "M" relativamente próximas. Para `length_c` e `diameter_c`, possivelmente não há interação com `sex`, já que as retas parecem estar apenas transladadas. Já no caso de `shell_w`, parece haver inclinação maior para `sex` = I.

Vamos construir um modelo completo, incluindo interação entre os termos das variáveis quantitativas e a variável categórica. Por simplicidade, decidiu-se não adicionar termo de interação com variável categórica aos termos que já são de interação entre diferentes variáveis.

$$
  E[age] = \beta_0 + \beta_1 length_c + \beta_{11}length_c^2  + \beta_2 diameter_c + \beta_{22} diameter_c^2 +  \beta_3 shell_{wc} + \beta_{33} shell_{wc}^2 + \beta_{4} sex + \beta_{12} length_c \cdot diameter_c + \beta_{13} length_c \cdot shell_{wc} + \beta_{23} diameter_c \cdot shell_{wc} + \beta_{14} length_c \cdot sex + \beta_{24} length_c \cdot diameter + \beta_{34} shell_{wc} \cdot sex + \beta_{114} length_c^2 \cdot sex + \beta_{224} diameter_c^2 \cdot sex + \beta_{334} shell_{wc}^2 \cdot sex
$$
```{r}
# modelo incluindo todas as variáveis (numéricas e categórica)
m1_all <- lm(age ~ diameter_c*length_c + shell_w_c*length_c  + sex + I(length_c^2)*sex + I(diameter_c^2)*sex + I(shell_w_c^2)*sex + diameter_c*sex + shell_w_c*sex + length_c*sex, data = abalone)


# resumo do modelo
summary(m1_all)
```

Percebe-se que, para `length_c^2`, `diameter_c^2`, `shell_w_c^2`, `diameter_c` e `length_c`, todos os termos de interação com `sex` não são significativos. Vamos refazer o modelo, considerando então somente o termo de interação de `sex` com `shell_w_c`:

```{r}
m1_quali_red <- lm(age ~ I(length_c^2) + I(diameter_c^2) + I(shell_w_c^2) +  diameter_c*length_c + shell_w_c*length_c  + sex + shell_w_c*sex, data=abalone)

summary(m1_quali_red)

```

Realizando o teste de hipótese ao comparar com `m1_all`:
Ho: $\beta_{14} = \beta_{24} = \beta_{114} = \beta_{224} = \beta_{334} = 0$  
Ha: nem todos os coeficientes são nulos
```{r}
# teste-F (comparação de modelos aninhados)
anova(m1_all, m1_quali_red, test="F")
```

Não podemos rejeitar a hipótese nula, logo consideramos que todos os coeficientes de interação de sex, exceto com `shell_w` são nulos.

Com esse resumo de modelo, percebemos que o coeficiente de `length_c:shell_w_c` é considerada como não significativa. Possivelmente, a adição de `sex` e suas interações ao modelo tira a necessidade de termos esse termo no modelo. Vamos avaliar se é possível retirá-lo:

```{r}
m1_quali_red_2 <- lm(age ~ I(length_c^2) + I(diameter_c^2) + I(shell_w_c^2) +  diameter_c*length_c + sex + shell_w_c*sex, data=abalone)

summary(m1_quali_red_2)
```
Chega-se em um modelo que possui o mair coeficiente de determinação ajustado até então que possui, com exceção de `sexM:shell_w_c` e `diameter_c`, todos os coeficientes significativos. Perceba, porém, que os termos citados como não significativos precisam ser incluídos no modelo, respectivamente porque `diameter_c_^2` e `sexI:shell_w_c` são significativos. Avaliaremos a hipótese da equivalência e `m1_quali_red` com `m1_quali_red_2`:

Ho: $\beta_{13} = 0$  
Ha: $\beta_{13} \neq 0$
```{r}
anova(m1_quali_red, m1_quali_red_2, test="F")
```

Não podemos rejeitar a hipótese nula, confirmando então que podemos retirar o termo de interação de `shell_w_c` e `length_c` do modelo final. Chegamos então ao modelo 1 dado por:
$$
  E[age] = \beta_0 + \beta_1 length_c + \beta_{11}length_c^2  + \beta_2 diameter_c + \beta_{22} diameter_c^2 +  \beta_3 shell_{wc} + \beta_{33} shell_{wc}^2 + \beta_{4} sex + \beta_{12} length_c \cdot diameter_c + \beta_{34} shell_{wc} \cdot sex
$$
```{r}
m1_final <- m1_quali_red_2

summary(m1_final)
```

Tem-se, portanto, um modelo significativo pela estatística F e o coeficiente de determinação de aproximadamente 48% indica que parte da variação da resposta é explicada pelo modelo. Os coeficientes são significativos para um nível de significância de 5%.

Podemos por fim analisar o gráfico de resíduos e o gráfico de quantis normais desse modelo:

```{r}
#| layout-ncol: 2

# Constrói tabela com dados do modelo `m_red`
abalone_m1_final_data <- abalone %>%
  # inclui coluna com valores ajustados
  mutate(fitted = m1_final$fit) %>%
  mutate(resid = m1_final$res)

# Gera gráficos dos resíduos:
ggplot(abalone_m1_final_data, aes(x = fitted, y = resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ggtitle("gráfico de resíduos: modelo m1_final") +
  labs(y = "resíduos", x = "resposta ajustada (age)")
# Gráfico de quantis
ggplot(abalone_m1_final_data, aes(sample = resid)) +
  stat_qq() + stat_qq_line() +
  ggtitle("gráfico de quantis normais") +
  labs(y = "quantis amostrais", x = "quantis teóricos (dist. normal)") 
```
Percebe-se gráficos bem similares ao modelo só com variáveis quantitiativas, que possui os mesmos problemas (ainda que não muito graves) dele. Podemos também avaliar a tabela anova desse modelo:

```{r}
anova(m1_final)
```
Percebe-se que, com exceção de `diameter_c^2`, todos os coeficientes do modelo ajudam na redução da variabilidade da resposta.

Conclui-se então que o modelo 1 é adequado para modelagem de `age`, ainda que sejam esperados intervalos de confiança e previsão relativamente largos dado que o gráfico de resídups é relativamente esparso e o coeficiente de determinação ajustado não é muito alto.

---

## Construção do Modelo 2

### Modelo de Variáveis Quantitativas

Para o segundo modelo, consideramos como variáveis explicativas `height`, `diameter`, `shell_w` e `sex`. Assim como antes, primeiro construiremos o modelo com as variáveis quantitativas. Dessa forma, temos:

$$
\begin{align}
E[age] = &\beta_0+\beta_1\cdot height +\beta_{11}\cdot height^2 + \beta_2\cdot diameter +\beta_{22}\cdot diameter^2\\
      +  &\beta_3\cdot shell\_w +\beta_{33}\cdot shell\_w^2 + \beta_{12}\cdot height\cdot diameter\\
      +  &\beta_{13}\cdot height\cdot shell\_w + \beta_{23}\cdot diameter\cdot shell\_w
\end{align}
$$
Podemos, então, agrupar a correlação dos diferentes termos do modelo na tabela abaixo.

| Termos Analisados                  | Correlação                                    |
|------------------------------------|-----------------------------------------------|
| `height` e `height`*`height`       | `r cor(abalone$height, abalone$height^2)`     |
| `diameter` e `diameter`*`diameter` | `r cor(abalone$diameter, abalone$diameter^2)` |
| `shell_w` e `shell_w`*`shell_w`    | `r cor(abalone$shell_w, abalone$shell_w^2)`   |


Percebe-se que a correlação referente a `diameter` e `shell_w` é bastante alta, enquanto `height` beira 75%. Como já foram analisados anteriormente, geraremos apenas o diagrama de dispersão referente à variável `height`. Através da análise deste, nota-se que há a presença
de dois _outliers_, que causam a redução no valor de correlação obtido. Podemos retirá-los do _dataset_, gerando o segundo gráfico de dispersão.

```{r}
#| layout-ncol: 2
# diagramas de dispersão
ggplot(abalone, aes(x = height, y = height^2)) +
  geom_point() +
  ggtitle("Diagrama de dispersão: `height^2` x `height`")

abalone <- abalone[abalone$height < 100,]

ggplot(abalone, aes(x = height, y = height^2)) +
  geom_point() +
  ggtitle("Diagrama de dispersão: `height^2` x `height` -- Sem Outlier")
```
Dessa forma, temos que o novo valor de correlação entre `height` e `height`*`height` é dado por `r cor(abalone$height, abalone$height^2)`, que, assim como nos anteriores, é bastante próximo de 1.

A seguir, podemos centralizar as variáveis explicativas, como feito no primeiro modelo, e obter a nova correlação apenas para a variável `height`, dado que, para as demais, isso já foi feito anteriormente. Nota-se que, como nos casos anteriores, há uma redução significativa no valor obtido.

```{r}
# centralizando a variável explicativa
abalone <- abalone |>
  mutate(height_c = height - mean(height))

# nova correlação
cor(abalone$height_c, abalone$height_c^2)
```

A seguir, construímos um modelo inicial análogo ao primeiro.

```{r}
# modelo polinomial de 2a. ordem completo para as variáveis quantitativas
m2_quant <- lm(age ~ height_c + I(height_c^2) + diameter_c + I(diameter_c^2) +  shell_w_c + I(shell_w_c^2) + height_c*shell_w_c+ diameter_c*height_c + diameter_c* shell_w_c  , data = abalone)

# resumo do modelo 
summary(m2_quant)
```

Analisando o _summary_ referente ao segundo modelo, constatamos que ele é significativo, dado que o p-valor da sua estatística F é inferior a $10^{-16}$, e que o seu coeficiente de determinação ajustado indica que aproximadamente 46% da variabilidade da resposta é explicada pelo modelo. Considerando um nível de significância de 5%, constatamos que os coeficientes `I(shell_w_c^2)`, `height_c:diameter_c` e `shell_w_c:diameter_c` não são significativos. Assim, dado que não há requisitos de presença decorrentes do princípio da hierarquia, consideraremos um modelo reduzido que não considera estas variáveis.

```{r}
# modelo reduzido
m2_red <- lm(age ~ height_c + I(height_c^2) + diameter_c + I(diameter_c^2) + shell_w_c + height_c*shell_w_c, data = abalone)

# resumo do modelo 
summary(m2_red)
```

Nota-se que, agora, todos os coeficientes são estatisticamente significantes, que o modelo reduzido ainda é significativo, com p-valor da estatística F inferior a $10^{-16}$, e que o coeficiente de determinação ajustado é um pouco inferior, e indica que 45.5% da variabilidade do modelo foi capturada.

A seguir, iremos realizar o teste de hipótese com $H_0:\beta_{33}=\beta_{12}=\beta_{23}=0$, que representa o modelo reduzido, e $H_a:\beta_{ij}\neq0, \text{para algum par ij}$.

```{r}
# teste-F (comparação de modelos aninhados)
anova(m2_red, m2_quant, test="F")
```

Assim, nota-se que podemos aceitar a Hipótese Nula, dado que temos um p-valor de aproximadamente 28%. Portanto, descartamos as três variáveis que consideramos, e temos o modelo reduzido a seguir.

$$
\begin{align}
E[age] = &\beta_0+\beta_1\cdot height +\beta_{11}\cdot height^2 + \beta_2\cdot diameter +\beta_{22}\cdot diameter^2\\
      +  &\beta_3\cdot shell\_w + \beta_{13}\cdot height\cdot shell\_w\\
\end{align}
$$

Seguimos, então, para a análise de resíduos, de maneira a determinar a validade do modelo.

```{r}
#| layout-ncol: 2
# Constrói tabela com dados do modelo `m_red`
m2_red_data <- abalone %>%
  # inclui coluna com valores ajustados
  mutate(fitted = m2_red$fit) %>%
  mutate(resid = m2_red$res)

# Gera gráficos dos resíduos
ggplot(m2_red_data, aes(x = fitted, y = resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ggtitle("Gráfico de Resíduos: Modelo 2 Reduzido") +
  labs(y = "resíduos", x = "resposta ajustada (age)")


# Gráfico de quantis
ggplot(m2_red_data, aes(sample = resid)) +
  stat_qq() + stat_qq_line() +
  ggtitle("Gráfico de Quantis Normais: Modelo 2 Reduzido") +
  labs(y = "Quantis Amostrais", x = "Quantis Teóricos (dist. normal)") 
```

Pela análise dos gráficos de resíduos, não parece existir uma variação sistemática nos resíduos, porém, nota-se um efeito cone, que indica variância não constante, e aumentando com o valor de `age`. Pode-se, então, realizar o teste de Breusch-Pagan para verificar essa constatação. O gráfico de quantis, por sua vez, parece indicar um desvio da normalidade na cauda da distribuição, que é mais alongada que uma distribuição normal.

```{r}
# Teste de Homoscedasticidade de Breusch-Pagan
# Ho: sigma^2  = cte
# Ha: sigma^2 != cte

library(lmtest)
bptest(m2_red)
```

Nota-se, portanto, que o teste rejeita a Hipótese Nula, e confirma a violação da hipótese de homoscedasticidade e normalidade. Eventualmente, esse desvio pode ser reduzido através de transformações de variáveis, porém, espera-se que ele não cause grandes problemas.

### Inclusão da Variável Categórica

Primeiramente, realizamos a inclusão da variável categórica `sex` ao modelo reduzido obtido anteriormente.

```{r}
# Inclusão da variável categórica no modelo
m2_qual <- lm(age ~ height_c + I(height_c^2) + diameter_c + I(diameter_c^2) + shell_w_c + height_c*shell_w_c + sex, data = abalone)

# Resumo
summary(m2_qual)
```

Nota-se que, assim como antes, o modelo apresenta-se como significativo, com um p-valor do Teste F inferior a $10^{-16}$, e com um coeficiente de determinação ajustado indicando que aproximadamente 46% da variabilidade da resposta foi capturada. Adotando um nível de significância de 5%, entretanto, também percebemos que o nível Masculino não possui significância estatística para o modelo, porém, como para os demais níveis o p-valor excede 5%, consideramos ela como significativa.

Realizando a inclusão das variáveis categóricas, e dos termos de interação, temos o modelo abaixo.

```{r}
# Inclusão da variável categórica e interações no modelo
m2_qual_full <- lm(age ~ height_c + I(height_c^2) + diameter_c + I(diameter_c^2) + shell_w_c + height_c*shell_w_c
                   + height_c * sex + I(height_c^2) * sex + diameter_c * sex + I(diameter_c^2) * sex + shell_w_c * sex + sex, data = abalone)

# Resumo
summary(m2_qual_full)
```

Primeiramente, temos que o modelo apresenta-se como significativo estatisticamente, com um p-valor no teste F inferior a $10^{-16}$, e coeficiente de determinação ajustado de aproximadamente 46%. Adotando, novamente, um nível de significância de 5%, temos uma série de termos que não possuem significância estatística nesse modelo, sendo eles `I(height_c^2)`, para os três níveis da variável categórica, `height_c`, `I(height_c^2)`, `diameter_c`, `shell_w_c`, todos para os níveis Masculino e Infante, e `I(diameter_c^2)` apenas para o nível Infante. Portanto, consideramos o modelo reduzido a seguir.

```{r}
# Inclusão da variável categórica e interações no modelo
m2_qual_red <- lm(age ~ height_c + diameter_c + I(diameter_c^2) + shell_w_c + height_c*shell_w_c
                   + height_c * sex + I(height_c^2) * sex + diameter_c * sex + I(diameter_c^2) * sex + shell_w_c * sex + sex, data = abalone)

# Resumo
summary(m2_qual_red)
```





---
